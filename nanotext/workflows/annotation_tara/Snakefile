'''
source activate ...
snakemake --configfile config.json --keep-going --cores 8
'''
import random
import sys


shell.executable('/bin/bash')

IDS, = glob_wildcards(config['genomes'] + '{sample}.fa')  # .gz
# print(IDS)
# IDS = set([i for i in IDS if not j in i for j in ['._GCA', '.fai']])
# print(IDS)
# index files generated by OS for exFAT formatting of external hard drive


# GENOME=GCA_000009925.1_ASM992v1_genomic.fna
# threads = 8
# ram = 14
outdir = config['outdir'] + 'data/'
logdir = config['outdir'] + 'log/'
# metadir = config['outdir'] + 'meta/'
# scripts = config['scripts']


rule all:
    input:
        expand(outdir + '{sample}/orfs.domtbl', sample=IDS),


# rule unzip:
#     input:
#         config['genomes'] + '{id}_genomic.fna.gz'
#     output:
#         config['genomes'] + '{id}_genomic.fna'
#     shell:
#         '''
#         gunzip {input}
#         '''


rule call_orfs:
    input:
        config['genomes'] + '{id}.fa'
    output:
        outdir + '{id}/orfs.fa'
    log:
        logdir + 'prodigal/{id}.log'
    shell:
        '''
        prodigal -i {input} -f gff -a {output} > /dev/null 2> {log}
        '''


rule hmm:
    '''
    rule is rerun although out output exists if upstream timestamp changes:
    https://bitbucket.org/snakemake/snakemake/issues/716/target-output-exists-but-rule-is-run
    '''
    input:
        db = config['database'],
        orfs = outdir + '{id}/orfs.fa'
    output:
        outdir + '{id}/orfs.domtbl'
    threads:
        1  # HMMER is not really using all cores
    log:
        logdir + 'hmm/{id}.log'
    shell:
        '''
        hmmscan --cut_ga --noali --cpu {threads} --domtblout {output} \
            {input.db} {input.orfs} \
            > {log} 2>&1
        '''


'''
# we ran hmmscan on the MAGs and now need to filter, reformat, remove domain
# overlaps and remove repetitive domains (maybe the latter two steps are not
# necessary, let's first try w/o them)

source activate function
cd /path/to/nanotext/data/tara/annotation/data

for i in $(ls)
do
    echo $i
    python /path/to/HmmPy.py \
        --cov 0.35 --evalue 1e-18 \
        ${i}/orfs.domtbl \
        > ${i}/orfs.domtbl.tsv
done
'''


